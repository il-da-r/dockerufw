# Docker и UFW без отключения iptables

UFW - это популярный интерфейс iptables в Ubuntu, упрощающий управление правилами брандмауэра. Но Docker обходит правила UFW и опубликованные порты могут быть доступны извне. 
Как обычно происходит:
1) UFW включен и все входящие соединения, которые не разрешены, по умолчанию блокируются. 
2) Запускаем контейнер Docker на сервере, используя параметр -p, чтобы опубликовать порты для этого контейнера на всех IP-адресах. Например: docker run -d --name httpd -p 0.0.0.0:8080:80 httpd: alpine, эта команда запустит службу httpd и опубликует порт 80 контейнера на порту 8080 сервера. 
3) UFW не будет блокировать все внешние запросы на посещение порта 8080. Даже команда ufw deny 8080 не будет препятствовать внешнему доступу к этому порту. Получается порт, который изначально должен был быть доступен только внутри подсети, оказался доступен публичной сети.

Есть решения связанные с необходимостью отключить функцию iptables докера, но при этом мы отказываемся от функции управления сетью докера. Это приводит к тому, что контейнеры не смогут получить доступ к внешней сети. Необходимо будет добавить правила в файл конфигурации UFW, например -A POSTROUTING ! -o docker0 -s 172.17.0.0/16 -j MASQUERADE. При создании новой подсети в докере, мы должны добавить подобные правила iptables для новой подсети.

Новое решение поможет: 
 - не отключать iptables Docker и можно будет с помощью Docker управлять своей сетью. Нам не нужно вручную поддерживать правила iptables для любых новых сетей Docker и избегать потенциальных побочных эффектов после отключения iptables в Docker. 
- при этом публичная сеть не может получить доступ к портам, опубликованным Docker. Даже если порт опубликован на всех IP-адресах с использованием параметра, например -p 8080: 80. Контейнеры и внутренние сети могут нормально посещать друг друга. Несмотря на то, что Docker может опубликовать порт контейнера на частный IP-адрес сервера, доступ к этому порту в общедоступной сети невозможен. Но этот сервер может иметь несколько частных IP-адресов, и эти частные IP-адреса также могут измениться. 
- очень удобным способом разрешить / запретить публичным сетям доступ к портам-контейнерам без дополнительного программного обеспечения и дополнительных настроек. 


# Что необходимо сделать? 

Необходимо изменить файл конфигурации UFW /etc/ufw/after.rules. Добавляем следующие правила в конце файла:

    # UFW DOCKER
  
    *filter
  
    :ufw-user-forward - [0:0]
  
    :DOCKER-USER - [0:0]
  
    # Следующие правила позволяют локальным подсетям 
  
    # иметь возможность доступа друг к другу.
  
    -A DOCKER-USER -j RETURN -s 10.0.0.0/8
  
    -A DOCKER-USER -j RETURN -s 172.16.0.0/12
  
    -A DOCKER-USER -j RETURN -s 192.168.0.0/16

    # Если докер-контейнер не соответствует настройкам ОС при получении данных, то есть минимальный номер порта меньше 32768. 

    # Например, у нас есть контейнер Dnsmasq. # Минимальный номер порта, который Dnsmasq использует для получения данных, составляет 1024. 
    # Мы можем использовать следующую команду, чтобы разрешить больший диапазон портов, используемых для получения пакетов DNS.

    -A DOCKER-USER -p udp -m udp --sport 53 --dport 1024:65535 -j RETURN

    # правилo позволяет UFW определять, разрешено ли общедоступным сетям посещать службы, предоставляемые контейнером Docker. 
    
    -A DOCKER-USER -j ufw-user-forward

    # Например, если мы хотим опубликовать порт 8080 контейнеров, используйте следующую команду:
    
    # ufw route allow 8080
    
    # Особенности: невозможно выставить службы, работающие на хостах и контейнерах одновременно, одной и той же командой. 
    
    # Но порт 8080 хоста по-прежнему недоступен для публичной сети. 
    
    # Если мы хотим сделать это, выполните следующую команду, чтобы разрешить общий доступ к порту на хосте отдельно:
    
    # ufw allow 8080
    
    # Не поддерживает более старые версии Ubuntu (где нет поддержки ufw route)

    # Вместо правила выше можно использовать 
    
    #-A DOCKER-USER -j ufw-user-input. 
    
    # Простой в использовании и понимании, поддерживает старые версии Ubuntu. 
    
    # Например, чтобы разрешить посещать опубликованный порт, порт контейнера которого 8080, 
    
    # используйте команду: ufw allow 8080
    
    # Он не только предоставляет порты контейнеров, но также предоставляет порты хоста. 
    # Например, если на хосте запущена служба, а порт - 8080. 
    
    # Команда ufw allow 8080 # позволяет общедоступной сети посещать службу и все опубликованные порты, порты контейнеров которых 8080.     
    # Но мы просто хотим выставить службу работающий на хосте, или 
    
    # только сервис, работающий внутри контейнеров, а не оба. 
    
    #Чтобы избежать этой проблемы, нам может понадобиться использовать команду, аналогичную следующей для всех контейнеров:
    
    # ufw allow proto tcp from any to 172.16.0.3 port 8080

    # Правила блокируют запросы на подключение, инициированные всеми общедоступными сетями, 
    
    # но разрешают внутренним сетям доступ к внешним сетям. 
    
    # Для протокола TCP это препятствует активному установлению соединения TCP из общедоступных сетей. 
    
    # Для протокола UDP все доступы к портам меньше 32767 заблокированы. 
    
    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16
    
    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8
    
    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12
    
    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 192.168.0.0/16
    
    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 10.0.0.0/8
    
    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 172.16.0.0/12

    -A DOCKER-USER -j RETURN
    
    COMMIT
    
    # END UFW AND DOCKER

С помощью команды sudo systemctl перезапустите ufw или запустите sudo ufw reload, чтобы перезапустить UFW после изменения файла. 

Теперь общедоступная сеть не может получить доступ к каким-либо опубликованным портам док-станции, контейнер и частная сеть могут нормально посещать друг друга, и контейнеры также могут обращаться к внешней сети изнутри. Если правила UFW не вступят в силу после перезапуска UFW, перезагрузите сервер.

Если вы хотите разрешить общедоступным сетям доступ к службам, предоставляемым, например, контейнером Docker, служебный порт контейнера равен 80. Выполните следующую команду, чтобы разрешить доступ к этой службе:

    ufw route allow proto tcp from any to any port 80
    
Это позволяет общедоступной сети получать доступ ко всем опубликованным портам, порт контейнера которых равен 80. 

Примечание. Если мы публикуем порт с помощью параметра -p 8080: 80, нам следует использовать порт контейнера 80, а не порт хоста 8080. 

Если существует несколько контейнеров с сервисным портом 80, но мы хотим, чтобы только внешняя сеть имела доступ к определенному контейнеру. Например, если частный адрес контейнера - 172.17.0.2, используйте следующую команду:

    ufw route allow proto tcp from any to 172.17.0.2 port 80

Если сетевым протоколом службы является UDP, например служба DNS, вы можете использовать следующую команду, чтобы разрешить внешней сети доступ ко всем опубликованным службам DNS:

    ufw route allow proto udp from any to any port 53

Точно так же, если только для определенного контейнера, такого как IP-адрес 172.17.0.2:

    ufw route allow proto udp from any to 172.17.0.2 port 53

---------------------------

Переведено и взято отсюда:

https://github.com/chaifeng/ufw-docker
